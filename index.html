<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ficocelli Family Expense Settlement Tool</title>
</head>
<body>

<table class="inputTable">
    <tbody class="inputTableBody">
    <tr>
        <th>Group Name</th>
        <th>Expenses</th>
        <th>Adults</th>
        <th>Kids</th>
        <th>Arrival</th>
        <th>Departure</th>
        <th>Valid Data</th>
    </tr>
    </tbody>
</table>
<button class="addRow" onclick="addInputRows(1)">[ + ] Add Another Row</button>
<button class="calc" onclick="update()">Calculate!</button>
<div id="calcs"></div>

</body>
</html>

<script>
    const ADULT_WEIGHT = 1;
    const KID_WEIGHT = .5;
    const BALANCE_TOLERANCE = 10;

    async function setup() {
        const data = await getExistingData();
        if (data) {
            addInputRows(data.length, data);
            update();
        } else {
            addInputRows(3);
        }
    }

    async function getExistingData () {
        const searchParams = new URLSearchParams(window.location.search)
        const data = searchParams.get("data");

        if (data) {
            try {
                const jsonString = atob(data);
                return await JSON.parse(jsonString);
            } catch(e) {
                console.error(e);
            }
        }

        //const sample_data = [{"id":"row0","name":"Me","expenses":"100","adults":"1","kids":"","arrival":"2020-12-29","departure":"2020-12-29","duration":2,"valid":true,"points":2,"expenseShare":"292.50","difference":"192.50"},{"id":"row1","name":"You","expenses":"400","adults":"2","kids":"","arrival":"","departure":"","duration":1,"valid":true,"points":2,"expenseShare":"292.50","difference":"-107.50"},{"id":"row2","name":"Him","expenses":"300","adults":"1","kids":"","arrival":"","departure":"","duration":1,"valid":true,"points":1,"expenseShare":"146.25","difference":"-153.75"},{"id":"row3","name":"them","expenses":"370","adults":"3","kids":"","arrival":"","departure":"","duration":1,"valid":true,"points":3,"expenseShare":"438.75","difference":"68.75"}];
        //return sample_data;
        return null;
    }

    function addInputRows(rows, data = {}) {
        const inputBody = document.querySelector(".inputTableBody");
        let rowId = 0;
        while (document.getElementById(`row${rowId}`)) {
            rowId++
        }

        function getKey(i, name) {
            return data[i] && data[i][name] ? `value="${data[i][name]}"` : "";
        }

        for (let i = 0; i < rows; i++) {
            const row = document.createElement("tr");
            row.id = `row${i + rowId}`;
            row.classList.add("inputRow");
            row.innerHTML = `<td class="name"><input name="name" type="text" ${getKey(i, "name")} onblur="update()"/></td>
                <td class="expenses">$<input name="expenses" type="number" step="any" ${getKey(i, "exp")} onchange="update()"/></td>
                <td class="adults"><input name="adults" type="number" ${getKey(i, "ad")} onchange="update()"/></td>
                <td class="kids"><input name="kids" type="number" ${getKey(i, "kd")} onchange="update()"/></td>
                <td class="arrival"><input name="arrival" type="date" ${getKey(i, "arr")} onchange="update()"/></td>
                <td class="departure"><input name="departure" type="date" ${getKey(i, "dep")} onchange="update()"/></td>
                <td class="validate"></td>`
            inputBody.appendChild(row);
        }
    }

    function update() {
        const data = getFormData();

        updateQueryParams(data);
        addCalculatedValues(data);

        const validData = data.filter(group => group.valid);

        calculate(validData);
        getTransactions(validData);
    }

    function getFormData() {
        const rows = document.querySelectorAll(".inputRow");
        const dataSet = [];

        rows.forEach(row => {
            const data = {
                id: row.id,
                name: row.querySelector(".name input").value,
                exp: row.querySelector(".expenses input").value,
                ad: row.querySelector(".adults input").value,
                kd: row.querySelector(".kids input").value,
                arr: row.querySelector(".arrival input").value,
                dep: row.querySelector(".departure input").value
            }
            
            dataSet.push(data);
        })

        return dataSet;
    }

    function updateQueryParams(data) {
        const dataString = JSON.stringify(data);
        const base64String = btoa(dataString);
        if ('URLSearchParams' in window) {
            const searchParams = new URLSearchParams(window.location.search)
            searchParams.set("data", base64String);
            const newRelativePathQuery = window.location.pathname + '?' + searchParams.toString();
            history.pushState(null, '', newRelativePathQuery);
        }

    }

    function addCalculatedValues(dataSet) {

        dataSet.forEach(data => {
            if (!data.arr && !data.dep) {
                data.duration = 1;
            } else {
                data.duration = (
                    (new Date(data.dep).getTime() - new Date(data.arr).getTime())
                    / (1000 * 3600 * 24)
                ) + 1;
            }
            data.valid = data.name && data.exp !== "" && (data.ad || data.kd) && data.duration > 0;
            data.points = (data.ad * ADULT_WEIGHT + data.kd * KID_WEIGHT) * data.duration;

            document.querySelector(`#${data.id} .validate`).innerHTML = data.valid ? "<span class='valid'>â˜‘</span>" : "<span class='invalid'>X</span>";
        });
    }

    function calculate(validData) {
        const totalExpenses = validData.reduce((acc, data) => +data.exp + acc, 0);
        const totalPoints = validData.reduce((acc, data) => +data.points + acc, 0);
        const pointValue = totalExpenses / totalPoints;

        validData.forEach(data => {
            data.expenseShare = (data.points * pointValue).toFixed(2);
            data.difference = ((data.points * pointValue) - data.exp).toFixed(2);
        })

        const rowsString = validData.map(data =>
            `<tr>
                <td>${data.name}</td>
                <td>${data.points}</td>
                <td>$ ${data.exp}</td>
                <td>$ ${data.expenseShare}</td>
                <td>$ ${data.difference}</td>
            </tr>`
        ).join("");


        if (validData.length) {
            document.getElementById("calcs").innerHTML = `
                <table>
                    <tr>
                        <td>Name</td>
                        <td>Points</td>
                        <td>Expenses</td>
                        <td>Expense Share</td>
                        <td>Difference</td>
                    </tr>
                    ${rowsString}
                </table>`
        }
    }

    function getTransactions(validData) {
        let subsets = getBalancedSubsets(validData);

        // TODO

    }
    function getBalancedSubsets(validData) {
        // ignore all subsets that are empty or the full set
        const subsets = getAllSubsets(validData)
            .filter(subset => subset.length);

        // Find any subsets who sum to within the balance tolerance
        // This finds any sub-groups that can be treated as their own ledger with minimal loss
        const balancedSubsets = subsets.filter(subset =>
                Math.abs(
                    subset.reduce((acc, data) => +data.difference + acc, 0)
                ) < BALANCE_TOLERANCE
            );

        if (balancedSubsets.length > 1) {
            // If there are balanced subsets other than the full set, only return those
            return balancedSubsets.filter(subset => subset.length < validData.length)
        } else {
            // return [[...validData]]
            return balancedSubsets;
        }
    }

    function getAllSubsets(array) {
        return array.reduce(
            (subsets, value) => subsets.concat(
                subsets.map(set => [value,...set])
            ),
            [[]]
        );
    }


    setup();

</script>

<style>
    table {
        border-spacing: 0;
        padding: 10px;
        font-size: 16px;
    }
    th {
        border: 1px solid black;
    }
    td {
        border: 1px solid lightgray;
        padding: 1px 3px;
        text-align: center;
    }

    .valid {
        color: green;
    }
    .invalid {
        color: red;
    }

    button {
        margin: 20px;
        border-radius: 8px;
        padding: 10px 20px;
    }

    .calc {
        background-color: darkgreen;
        color: white;
    }

    input {
        font-size: 16px;
        max-width: 20vw;
    }

    input[type="number"] {
        width: 43px;
    }

    /* Hide number input arrows on Chrome, Safari, Edge, Opera */
    .expenses input::-webkit-outer-spin-button,
    .expenses input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Hide number input arrows on Firefox */
    .expenses input[type=number] {
        -moz-appearance: textfield;
    }

</style>